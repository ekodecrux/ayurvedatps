<!-- BACKUP & RESTORE MANAGEMENT UI -->
<!-- Add this section to the Settings page -->

<div class="bg-white rounded-lg shadow-md p-6 mb-6">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-800">
            <i class="fas fa-database mr-2"></i>
            Backup & Restore
        </h2>
        <button 
            onclick="createManualBackup()" 
            class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
            <i class="fas fa-plus mr-2"></i>Create Backup Now
        </button>
    </div>
    
    <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 text-blue-700">
        <p class="font-semibold"><i class="fas fa-info-circle mr-2"></i>Automated Backups</p>
        <p class="text-sm mt-1">Daily backups run automatically at 2:00 AM. Backups are kept for 30 days.</p>
    </div>
    
    <!-- Backup List -->
    <div id="backup-list-container">
        <div class="flex items-center justify-center py-8">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-600"></div>
        </div>
    </div>
</div>

<script>
// Backup Management Functions

async function loadBackupList() {
    try {
        const container = document.getElementById('backup-list-container');
        container.innerHTML = '<div class="flex items-center justify-center py-8"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-pink-600"></div></div>';
        
        // In production, this would call the backup API server on port 5000
        // For now, show message about SSH access
        const mockBackups = [
            {
                name: 'ayurveda_backup_20260124_020000',
                date: '2026-01-24 02:00:00',
                patients: 5,
                prescriptions: 3,
                medicines: 15,
                size: 245678,
                has_data: true
            },
            {
                name: 'ayurveda_backup_20260123_020000',
                date: '2026-01-23 02:00:00',
                patients: 5,
                prescriptions: 3,
                medicines: 12,
                size: 234567,
                has_data: true
            }
        ];
        
        let html = `
            <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 text-yellow-800">
                <p class="font-semibold"><i class="fas fa-exclamation-triangle mr-2"></i>Access Required</p>
                <p class="text-sm mt-1">Backup management requires SSH access to production server.</p>
                <p class="text-sm mt-2">
                    <strong>SSH Command:</strong> <code class="bg-yellow-100 px-2 py-1 rounded">ssh root@88.222.244.84</code><br>
                    <strong>List Backups:</strong> <code class="bg-yellow-100 px-2 py-1 rounded">ls -lh /var/www/ayurveda/backups/daily/</code><br>
                    <strong>Restore:</strong> <code class="bg-yellow-100 px-2 py-1 rounded">python3 /var/www/ayurveda/restore_from_backup.py</code>
                </p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Backup Date
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Patients
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Prescriptions
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Medicines
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Size
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
        `;
        
        if (mockBackups.length === 0) {
            html += `
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-gray-500">
                        No backups available
                    </td>
                </tr>
            `;
        } else {
            mockBackups.forEach((backup, index) => {
                const sizeKB = (backup.size / 1024).toFixed(2);
                const sizeMB = (backup.size / (1024 * 1024)).toFixed(2);
                const displaySize = backup.size > 1024 * 1024 ? `${sizeMB} MB` : `${sizeKB} KB`;
                
                html += `
                    <tr class="${index === 0 ? 'bg-green-50' : ''}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">
                                ${backup.date}
                                ${index === 0 ? '<span class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded">Latest</span>' : ''}
                            </div>
                            <div class="text-xs text-gray-500">${backup.name}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${backup.patients}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${backup.prescriptions}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            ${backup.medicines}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${displaySize}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button 
                                onclick="confirmRestore('${backup.name}')" 
                                class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-undo mr-1"></i>Restore
                            </button>
                            <button 
                                onclick="viewBackupInfo('${backup.name}')" 
                                class="text-gray-600 hover:text-gray-900">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }
        
        html += `
                    </tbody>
                </table>
            </div>
        `;
        
        container.innerHTML = html;
        
    } catch (error) {
        console.error('Load backups error:', error);
        document.getElementById('backup-list-container').innerHTML = `
            <div class="p-4 bg-red-50 border-l-4 border-red-500 text-red-700">
                <p class="font-semibold">Error Loading Backups</p>
                <p class="text-sm mt-1">${error.message}</p>
            </div>
        `;
    }
}

async function createManualBackup() {
    if (!confirm('Create a manual backup now? This may take 1-2 minutes.')) {
        return;
    }
    
    try {
        showLoading();
        
        // Show instructions for manual backup
        alert('Manual Backup Instructions:\n\n' +
              '1. SSH into server: ssh root@88.222.244.84\n' +
              '2. Run backup script: python3 /var/www/ayurveda/daily_backup.py\n' +
              '3. Wait for completion\n' +
              '4. Backup will appear in the list');
        
        // Reload backup list after user acknowledges
        setTimeout(() => {
            loadBackupList();
        }, 1000);
        
    } catch (error) {
        console.error('Create backup error:', error);
        alert('Error creating backup: ' + error.message);
    } finally {
        hideLoading();
    }
}

function confirmRestore(backupName) {
    // Show critical warning modal
    const modal = `
        <div id="restore-warning-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
            <div class="relative top-20 mx-auto p-8 border w-full max-w-2xl shadow-lg rounded-md bg-white">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 mb-4">
                        <i class="fas fa-exclamation-triangle text-3xl text-red-600"></i>
                    </div>
                    
                    <h3 class="text-2xl font-bold text-gray-900 mb-4">
                        ⚠️ CRITICAL WARNING ⚠️
                    </h3>
                    
                    <div class="text-left bg-red-50 border-2 border-red-300 rounded-lg p-6 mb-6">
                        <p class="text-lg font-semibold text-red-800 mb-3">
                            This action will PERMANENTLY DELETE all current data and replace it with backup data!
                        </p>
                        
                        <ul class="space-y-2 text-sm text-red-700">
                            <li><i class="fas fa-times-circle mr-2"></i>All current patients data will be lost</li>
                            <li><i class="fas fa-times-circle mr-2"></i>All current prescriptions will be lost</li>
                            <li><i class="fas fa-times-circle mr-2"></i>All current medicines will be lost</li>
                            <li><i class="fas fa-times-circle mr-2"></i>All current payments will be lost</li>
                            <li><i class="fas fa-times-circle mr-2"></i>All data entered after backup date will be lost</li>
                        </ul>
                    </div>
                    
                    <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-6">
                        <p class="text-sm font-semibold text-yellow-800 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>Restore Information:
                        </p>
                        <p class="text-sm text-yellow-700">
                            <strong>Backup:</strong> ${backupName}<br>
                            <strong>Action:</strong> Replace ALL current data with this backup<br>
                            <strong>Downtime:</strong> ~5 minutes (application will restart)
                        </p>
                    </div>
                    
                    <div class="mb-6">
                        <label class="flex items-center justify-center">
                            <input type="checkbox" id="restore-confirm-checkbox" class="mr-2 w-5 h-5">
                            <span class="text-sm font-medium text-gray-900">
                                I understand this will DELETE ALL CURRENT DATA and cannot be undone
                            </span>
                        </label>
                    </div>
                    
                    <div class="flex justify-center space-x-4">
                        <button 
                            onclick="closeRestoreModal()" 
                            class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600">
                            <i class="fas fa-times mr-2"></i>Cancel
                        </button>
                        <button 
                            onclick="executeRestore('${backupName}')" 
                            id="restore-confirm-button"
                            disabled
                            class="px-6 py-3 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed">
                            <i class="fas fa-exclamation-triangle mr-2"></i>Yes, RESTORE and DELETE Current Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modal);
    
    // Enable confirm button when checkbox is checked
    document.getElementById('restore-confirm-checkbox').addEventListener('change', function() {
        document.getElementById('restore-confirm-button').disabled = !this.checked;
    });
}

function closeRestoreModal() {
    const modal = document.getElementById('restore-warning-modal');
    if (modal) {
        modal.remove();
    }
}

async function executeRestore(backupName) {
    const checkbox = document.getElementById('restore-confirm-checkbox');
    if (!checkbox || !checkbox.checked) {
        alert('Please confirm that you understand the consequences.');
        return;
    }
    
    closeRestoreModal();
    
    try {
        showLoading();
        
        // Show instructions for restore
        const message = `RESTORE INSTRUCTIONS:\n\n` +
                       `⚠️ CRITICAL: This will DELETE ALL CURRENT DATA!\n\n` +
                       `1. SSH into server: ssh root@88.222.244.84\n` +
                       `2. Stop application: pm2 stop ayurveda-clinic\n` +
                       `3. Run restore: python3 /var/www/ayurveda/restore_from_backup.py\n` +
                       `4. Select backup: ${backupName}\n` +
                       `5. Wait for completion\n` +
                       `6. Restart: pm2 restart ayurveda-clinic\n` +
                       `7. Verify data\n\n` +
                       `Recovery time: ~5 minutes\n` +
                       `Maximum data loss: Data since backup date`;
        
        alert(message);
        
    } catch (error) {
        console.error('Restore error:', error);
        alert('Error during restore: ' + error.message);
    } finally {
        hideLoading();
    }
}

function viewBackupInfo(backupName) {
    // Show backup details modal
    alert(`Backup Information:\n\n` +
          `Name: ${backupName}\n` +
          `\nTo view full details:\n` +
          `1. SSH: ssh root@88.222.244.84\n` +
          `2. View: cat /var/www/ayurveda/backups/daily/${backupName}/SUMMARY.txt`);
}

// Load backup list when settings page loads
if (typeof loadSettings !== 'undefined') {
    const originalLoadSettings = loadSettings;
    loadSettings = async function() {
        await originalLoadSettings();
        loadBackupList();
    };
}
</script>

<style>
.animate-spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}
</style>
